<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Custom Replays</title>
  <style>
    :root {
      --bg: #0b0f17;
      --panel: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #60a5fa;
      --ok: #34d399;
      --warn: #fbbf24;
      --bad: #fb7185;
      --border: rgba(148,163,184,.18);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 15% 10%, rgba(96,165,250,.18), transparent 55%),
                  radial-gradient(900px 600px at 90% 5%, rgba(52,211,153,.12), transparent 55%),
                  var(--bg);
      color: var(--text);
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 22px 16px 40px;
    }

    header {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 14px;
    }
    h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: .2px;
      font-weight: 700;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
      background: rgba(17,24,39,.6);
    }

    .grid {
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
    }
    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      background: rgba(17,24,39,.78);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      backdrop-filter: blur(8px);
    }

    .label {
      font-size: 12px;
      color: var(--muted);
      margin: 10px 0 6px;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(2,6,23,.35);
      color: var(--text);
      outline: none;
    }
    textarea { min-height: 84px; resize: vertical; }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: end;
    }
    .row3 {
      display: grid;
      grid-template-columns: 1.3fr 1fr 1fr;
      gap: 10px;
      align-items: end;
    }
    @media (max-width: 520px) {
      .row, .row3 { grid-template-columns: 1fr; }
    }

    .btns { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    button {
      cursor: pointer;
      border: 1px solid var(--border);
      background: rgba(2,6,23,.35);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 13px;
    }
    button.primary {
      background: rgba(96,165,250,.18);
      border-color: rgba(96,165,250,.35);
    }
    button.good {
      background: rgba(52,211,153,.14);
      border-color: rgba(52,211,153,.35);
    }
    button:disabled {
      cursor: not-allowed;
      opacity: .55;
    }

    .hint {
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
    .status {
      margin-top: 10px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(2,6,23,.35);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
    }
    .status.ok { border-color: rgba(52,211,153,.35); }
    .status.warn { border-color: rgba(251,191,36,.35); }
    .status.bad { border-color: rgba(251,113,133,.35); }

    .segments {
      margin-top: 10px;
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }
    .seg {
      display: grid;
      grid-template-columns: 1.2fr 1fr auto;
      gap: 10px;
      align-items: center;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 14px;
      margin-top: 10px;
      background: rgba(2,6,23,.25);
    }
    @media (max-width: 520px) {
      .seg { grid-template-columns: 1fr; }
    }
    .seg small { color: var(--muted); }
    .seg .pill {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      width: fit-content;
    }

    .playerWrap {
      display: grid;
      gap: 14px;
    }
    .playerBox {
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: rgba(2,6,23,.25);
      aspect-ratio: 16 / 9;
      position: relative;
    }
    #player {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }
    .controls .left, .controls .right { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .mini {
      font-size: 12px;
      color: var(--muted);
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(2,6,23,.25);
    }
    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 11px;
      padding: 2px 6px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: rgba(2,6,23,.35);
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Custom Replays</h1>
        <div class="tag">One link, multiple time ranges, still plays on YouTube</div>
      </div>
      <div class="tag">Tip: press <span class="kbd">N</span> for next segment, <span class="kbd">P</span> for previous</div>
    </header>

    <div class="grid">
      <!-- Builder -->
      <div class="card">
        <div class="label">YouTube URL or Video ID</div>
        <input id="ytInput" type="text" placeholder="Paste a YouTube link (or just the video ID)" />

        <div class="row3" style="margin-top:10px;">
          <div>
            <div class="label">Label (optional)</div>
            <input id="segLabel" type="text" placeholder="Try build-up" />
          </div>
          <div>
            <div class="label">Start (mm:ss or hh:mm:ss)</div>
            <input id="segStart" type="text" placeholder="02:00" />
          </div>
          <div>
            <div class="label">End (mm:ss or hh:mm:ss)</div>
            <input id="segEnd" type="text" placeholder="03:00" />
          </div>
        </div>

        <div class="btns">
          <button id="addSeg" class="primary">Add segment</button>
          <button id="clearSegs">Clear segments</button>
        </div>

        <div class="hint">
          Add as many segments as you like. The replay will auto-jump from one to the next.
          It uses the official YouTube embed player, so views and monetisation remain with the creator.
        </div>

        <div class="segments" id="segmentsList"></div>

        <div class="label" style="margin-top:14px;">Share link (one URL)</div>
        <input id="shareLink" type="text" readonly />

        <div class="btns">
          <button id="copyLink" class="good" disabled>Copy link</button>
          <button id="openLink" disabled>Open link</button>
          <button id="loadNow" class="primary" disabled>Load into player</button>
        </div>

        <div id="builderStatus" class="status">Paste a YouTube link, add segments, then share one link.</div>

        <div class="hint" style="margin-top:10px;">
          Format notes:
          <br>• Times accepted: <b>ss</b>, <b>mm:ss</b>, <b>hh:mm:ss</b>
          <br>• Segments must have end greater than start
        </div>
      </div>

      <!-- Player -->
      <div class="card playerWrap">
        <div class="playerBox">
          <div id="player"></div>
        </div>

        <div class="controls">
          <div class="left">
            <button id="prevBtn" disabled>Prev</button>
            <button id="playBtn" disabled>Play</button>
            <button id="pauseBtn" disabled>Pause</button>
            <button id="nextBtn" disabled>Next</button>
          </div>
          <div class="right">
            <div class="mini" id="nowPlaying">No replay loaded</div>
          </div>
        </div>

        <div id="playerStatus" class="status">Load a replay to start. If a video does not play, embedding may be disabled by the uploader.</div>
      </div>
    </div>
  </div>

  <script>
    // -------------------------
    // Utilities
    // -------------------------
    function parseTimeToSeconds(input) {
      if (!input) return null;
      const s = String(input).trim();
      if (!s) return null;
      if (/^\d+$/.test(s)) return Number(s);

      const parts = s.split(":").map(p => p.trim());
      if (parts.some(p => p === "" || isNaN(Number(p)))) return null;
      const nums = parts.map(Number);

      if (nums.length === 2) {
        const [mm, ss] = nums;
        return mm * 60 + ss;
      }
      if (nums.length === 3) {
        const [hh, mm, ss] = nums;
        return hh * 3600 + mm * 60 + ss;
      }
      return null;
    }

    function secondsToHMS(sec) {
      sec = Math.max(0, Math.floor(sec));
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      if (h > 0) return `${h}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
      return `${m}:${String(s).padStart(2,"0")}`;
    }

    function extractYouTubeId(input) {
      const raw = String(input || "").trim();
      if (!raw) return null;

      // If user pasted just the ID
      if (/^[a-zA-Z0-9_-]{11}$/.test(raw)) return raw;

      try {
        const u = new URL(raw);
        const host = u.hostname.replace("www.","").replace("m.","");
        // youtu.be/VIDEOID
        if (host === "youtu.be") {
          const id = u.pathname.split("/").filter(Boolean)[0];
          if (id && /^[a-zA-Z0-9_-]{11}$/.test(id)) return id;
        }
        // youtube.com/watch?v=VIDEOID
        if (host.endsWith("youtube.com")) {
          const v = u.searchParams.get("v");
          if (v && /^[a-zA-Z0-9_-]{11}$/.test(v)) return v;

          // youtube.com/shorts/VIDEOID
          const parts = u.pathname.split("/").filter(Boolean);
          const shortsIdx = parts.indexOf("shorts");
          if (shortsIdx >= 0 && parts[shortsIdx + 1] && /^[a-zA-Z0-9_-]{11}$/.test(parts[shortsIdx + 1])) {
            return parts[shortsIdx + 1];
          }

          // youtube.com/embed/VIDEOID
          const embedIdx = parts.indexOf("embed");
          if (embedIdx >= 0 && parts[embedIdx + 1] && /^[a-zA-Z0-9_-]{11}$/.test(parts[embedIdx + 1])) {
            return parts[embedIdx + 1];
          }
        }
      } catch (e) {
        // Not a URL, ignore
      }

      // Try to find v=VIDEOID inside a string
      const m = raw.match(/[?&]v=([a-zA-Z0-9_-]{11})/);
      if (m) return m[1];

      return null;
    }

    function setStatus(el, msg, type) {
      el.textContent = msg;
      el.classList.remove("ok","warn","bad");
      if (type) el.classList.add(type);
    }

    // -------------------------
    // State
    // -------------------------
    let segments = []; // { label, start, end }
    let videoId = null;

    let player = null;
    let activeIndex = 0;
    let tickTimer = null;
    let isLoadedReplay = false;

    // -------------------------
    // DOM
    // -------------------------
    const ytInput = document.getElementById("ytInput");
    const segLabel = document.getElementById("segLabel");
    const segStart = document.getElementById("segStart");
    const segEnd = document.getElementById("segEnd");

    const addSeg = document.getElementById("addSeg");
    const clearSegs = document.getElementById("clearSegs");
    const segmentsList = document.getElementById("segmentsList");

    const shareLink = document.getElementById("shareLink");
    const copyLink = document.getElementById("copyLink");
    const openLink = document.getElementById("openLink");
    const loadNow = document.getElementById("loadNow");

    const builderStatus = document.getElementById("builderStatus");
    const playerStatus = document.getElementById("playerStatus");
    const nowPlaying = document.getElementById("nowPlaying");

    const prevBtn = document.getElementById("prevBtn");
    const playBtn = document.getElementById("playBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const nextBtn = document.getElementById("nextBtn");

    // -------------------------
    // Render + Share link
    // -------------------------
    function renderSegments() {
      segmentsList.innerHTML = "";
      if (segments.length === 0) {
        segmentsList.innerHTML = `<div class="hint">No segments yet. Add one above.</div>`;
        return;
      }

      segments.forEach((s, idx) => {
        const div = document.createElement("div");
        div.className = "seg";
        const label = s.label ? s.label : `Segment ${idx + 1}`;
        div.innerHTML = `
          <div>
            <div style="font-weight:800;">${escapeHtml(label)}</div>
            <small>${secondsToHMS(s.start)} to ${secondsToHMS(s.end)}</small>
          </div>
          <div class="pill">Start <b>${secondsToHMS(s.start)}</b> · End <b>${secondsToHMS(s.end)}</b></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button data-action="up" data-idx="${idx}" ${idx===0?"disabled":""}>Up</button>
            <button data-action="down" data-idx="${idx}" ${idx===segments.length-1?"disabled":""}>Down</button>
            <button data-action="del" data-idx="${idx}">Remove</button>
          </div>
        `;
        segmentsList.appendChild(div);
      });
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function buildShareUrl() {
      const base = new URL(window.location.href);
      base.searchParams.set("v", videoId || "");
      // cuts: start-end,start-end...
      const cuts = segments.map(s => `${s.start}-${s.end}`).join(",");
      base.searchParams.set("cuts", cuts);

      // labels: urlencoded, separated by |
      const labels = segments.map(s => (s.label || "").replaceAll("|","/")).join("|");
      base.searchParams.set("labels", labels);

      // optional: autoplay
      base.searchParams.set("autoplay", "1");

      return base.toString();
    }

    function refreshShareControls() {
      const ok = Boolean(videoId) && segments.length > 0;
      copyLink.disabled = !ok;
      openLink.disabled = !ok;
      loadNow.disabled = !ok;

      if (ok) {
        const url = buildShareUrl();
        shareLink.value = url;
        setStatus(builderStatus,
          `Ready. Share one link.\nVideo: ${videoId}\nSegments: ${segments.length}`,
          "ok"
        );
      } else {
        shareLink.value = "";
        if (!videoId) {
          setStatus(builderStatus, "Paste a YouTube link (or ID) first.", "warn");
        } else if (segments.length === 0) {
          setStatus(builderStatus, "Add at least one segment.", "warn");
        } else {
          setStatus(builderStatus, "Add video and segments to generate the share link.", "warn");
        }
      }
    }

    // -------------------------
    // Segment editing
    // -------------------------
    addSeg.addEventListener("click", () => {
      const id = extractYouTubeId(ytInput.value);
      if (!id) {
        setStatus(builderStatus, "Could not find a valid YouTube video ID in that input.", "bad");
        return;
      }
      videoId = id;

      const st = parseTimeToSeconds(segStart.value);
      const en = parseTimeToSeconds(segEnd.value);
      if (st === null || en === null) {
        setStatus(builderStatus, "Start and end must be valid times, for example 2:00 and 3:15.", "bad");
        return;
      }
      if (en <= st) {
        setStatus(builderStatus, "End must be greater than start.", "bad");
        return;
      }

      const lbl = segLabel.value.trim();
      segments.push({ label: lbl, start: st, end: en });

      segLabel.value = "";
      segStart.value = "";
      segEnd.value = "";

      renderSegments();
      refreshShareControls();
    });

    clearSegs.addEventListener("click", () => {
      segments = [];
      activeIndex = 0;
      renderSegments();
      refreshShareControls();
      setStatus(builderStatus, "Segments cleared.", "warn");
    });

    segmentsList.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const idx = Number(btn.dataset.idx);
      const action = btn.dataset.action;
      if (Number.isNaN(idx)) return;

      if (action === "del") {
        segments.splice(idx, 1);
      } else if (action === "up" && idx > 0) {
        const tmp = segments[idx - 1];
        segments[idx - 1] = segments[idx];
        segments[idx] = tmp;
      } else if (action === "down" && idx < segments.length - 1) {
        const tmp = segments[idx + 1];
        segments[idx + 1] = segments[idx];
        segments[idx] = tmp;
      }

      renderSegments();
      refreshShareControls();
    });

    ytInput.addEventListener("input", () => {
      const id = extractYouTubeId(ytInput.value);
      if (id) videoId = id;
      refreshShareControls();
    });

    copyLink.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(shareLink.value);
        setStatus(builderStatus, "Copied share link to clipboard.", "ok");
      } catch (e) {
        shareLink.select();
        setStatus(builderStatus, "Could not auto-copy. The link is selected, press Ctrl+C.", "warn");
      }
    });

    openLink.addEventListener("click", () => {
      window.open(shareLink.value, "_blank", "noopener,noreferrer");
    });

    loadNow.addEventListener("click", () => {
      if (!videoId || segments.length === 0) return;
      loadReplayIntoPlayer(videoId, segments);
    });

    // -------------------------
    // Player logic
    // -------------------------
    function enablePlayerControls(enabled) {
      prevBtn.disabled = !enabled;
      playBtn.disabled = !enabled;
      pauseBtn.disabled = !enabled;
      nextBtn.disabled = !enabled;
    }

    function loadReplayIntoPlayer(id, segs) {
      if (!player) {
        setStatus(playerStatus, "Player is not ready yet. If this persists, refresh the page.", "warn");
        return;
      }
      if (!id || !segs || segs.length === 0) return;

      isLoadedReplay = true;
      videoId = id;
      segments = segs;
      activeIndex = 0;

      renderSegments();
      refreshShareControls();

      setStatus(playerStatus, `Loaded replay.\nAuto-jump is active.`, "ok");
      enablePlayerControls(true);

      // Load video at first segment start
      player.loadVideoById({ videoId: videoId, startSeconds: segments[0].start });
      updateNowPlaying();
      startTicking();
    }

    function updateNowPlaying() {
      if (!isLoadedReplay || segments.length === 0) {
        nowPlaying.textContent = "No replay loaded";
        return;
      }
      const s = segments[activeIndex];
      const label = s.label ? s.label : `Segment ${activeIndex + 1}`;
      nowPlaying.textContent = `${label} (${secondsToHMS(s.start)} to ${secondsToHMS(s.end)})`;
    }

    function gotoSegment(index, play = true) {
      if (!isLoadedReplay) return;
      if (segments.length === 0) return;
      const i = Math.max(0, Math.min(index, segments.length - 1));
      activeIndex = i;
      const s = segments[activeIndex];
      updateNowPlaying();
      if (play) {
        player.seekTo(s.start, true);
        player.playVideo();
      } else {
        player.seekTo(s.start, true);
      }
    }

    function nextSegment() {
      if (!isLoadedReplay) return;
      if (activeIndex < segments.length - 1) gotoSegment(activeIndex + 1, true);
      else {
        // End behaviour: stop at end of last segment
        player.pauseVideo();
        setStatus(playerStatus, "Reached the final segment end.", "ok");
      }
    }

    function prevSegment() {
      if (!isLoadedReplay) return;
      if (activeIndex > 0) gotoSegment(activeIndex - 1, true);
      else gotoSegment(0, true);
    }

    function startTicking() {
      stopTicking();
      tickTimer = setInterval(() => {
        if (!player || !isLoadedReplay || segments.length === 0) return;
        const s = segments[activeIndex];
        const t = player.getCurrentTime ? player.getCurrentTime() : 0;
        // If user scrubs outside the current segment, gently pull them back in
        if (t < s.start - 0.35) {
          player.seekTo(s.start, true);
          return;
        }
        // If we reach end of current segment, jump
        if (t >= s.end - 0.12) {
          nextSegment();
        }
      }, 200);
    }

    function stopTicking() {
      if (tickTimer) clearInterval(tickTimer);
      tickTimer = null;
    }

    prevBtn.addEventListener("click", prevSegment);
    nextBtn.addEventListener("click", nextSegment);
    playBtn.addEventListener("click", () => player && player.playVideo && player.playVideo());
    pauseBtn.addEventListener("click", () => player && player.pauseVideo && player.pauseVideo());

    // Keyboard shortcuts
    window.addEventListener("keydown", (e) => {
      if (e.target && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")) return;
      const k = e.key.toLowerCase();
      if (k === "n") nextSegment();
      if (k === "p") prevSegment();
      if (k === " ") {
        e.preventDefault();
        const state = player && player.getPlayerState ? player.getPlayerState() : null;
        // 1 playing, 2 paused
        if (state === 1) player.pauseVideo();
        else player.playVideo();
      }
    });

    // -------------------------
    // Read URL params (shared links)
    // -------------------------
    function loadFromQueryIfPresent() {
      const params = new URLSearchParams(window.location.search);
      const v = params.get("v");
      const cuts = params.get("cuts");
      const labels = params.get("labels");
      const autoplay = params.get("autoplay") === "1";

      if (!v || !cuts) return;

      const id = extractYouTubeId(v);
      if (!id) return;

      const cutParts = cuts.split(",").map(s => s.trim()).filter(Boolean);
      const labelParts = (labels || "").split("|");

      const segs = [];
      for (let i = 0; i < cutParts.length; i++) {
        const [a,b] = cutParts[i].split("-").map(x => x.trim());
        const st = parseTimeToSeconds(a);
        const en = parseTimeToSeconds(b);
        if (st === null || en === null || en <= st) continue;
        segs.push({
          label: (labelParts[i] || "").trim(),
          start: st,
          end: en
        });
      }
      if (segs.length === 0) return;

      // Populate builder UI
      ytInput.value = `https://www.youtube.com/watch?v=${id}`;
      videoId = id;
      segments = segs;
      renderSegments();
      refreshShareControls();

      // Auto-load into player
      loadReplayIntoPlayer(id, segs);
      if (!autoplay) player.pauseVideo();
    }

    // -------------------------
    // YouTube IFrame API init
    // -------------------------
    function onYouTubeIframeAPIReady() {
      player = new YT.Player("player", {
        height: "100%",
        width: "100%",
        playerVars: {
          modestbranding: 1,
          rel: 0,
          playsinline: 1
        },
        events: {
          onReady: () => {
            setStatus(playerStatus, "Player ready. Build a replay on the left or open a share link.", "ok");
            enablePlayerControls(false);
            loadFromQueryIfPresent();
          },
          onError: (e) => {
            setStatus(playerStatus,
              `Playback error from YouTube (code ${e.data}).\nCommon cause: the uploader disabled embedding.`,
              "bad"
            );
          }
        }
      });
    }
    window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

    // Inject YouTube API script
    (function injectYT() {
      const tag = document.createElement("script");
      tag.src = "https://www.youtube.com/iframe_api";
      document.head.appendChild(tag);
    })();

    // Initial render
    renderSegments();
    refreshShareControls();
  </script>
</body>
</html>
